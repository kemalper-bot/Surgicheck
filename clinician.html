<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SurgiCheck | Klinisyen Paneli</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .chip { padding: 2px 10px; border-radius: 999px; font-size: 12px; border: 1px solid; }
    
    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; color: #000 !important; }
      .chip { border: 1pt solid #000 !important; color: #000 !important; background-color: transparent !important; }
      * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    }
  </style>
</head>
<body class="bg-slate-50">
<div class="max-w-6xl mx-auto p-6">

  <div class="flex items-center gap-4 mb-6 pb-4 border-b border-slate-200">
    <img src="logo.png" alt="SurgiCheck" class="h-12 md:h-14 object-contain" />
    <div>
      <h1 class="text-xl md:text-2xl font-semibold text-slate-800 tracking-tight">Klinisyen Paneli</h1>
      <p class="text-sm text-slate-500">Leo Klinik · Risk Yönetimi ve Preoperatif Değerlendirme</p>
    </div>
  </div>

  <div id="alert" class="hidden mb-4 rounded-lg p-3 text-sm font-medium"></div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <div class="bg-white rounded-xl shadow p-4 lg:col-span-1 border border-slate-100">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold text-slate-700">Vakalar</h2>
        <button id="refreshBtn" class="text-xs text-blue-600 hover:text-blue-800 underline">Yenile</button>
      </div>
      <input id="searchBox" class="w-full rounded-lg border border-slate-200 p-2.5 text-sm focus:outline-none focus:border-blue-400 bg-slate-50 focus:bg-white transition-colors" placeholder="Hasta Adı veya Prosedür Ara..." />
      <div id="caseList" class="mt-4 space-y-2 max-h-[70vh] overflow-y-auto pr-1">
        <div class="text-sm text-slate-400 py-8 text-center animate-pulse">Veriler Çekiliyor...</div>
      </div>
    </div>

    <div class="lg:col-span-2 space-y-4">

      <div id="emptyState" class="bg-white rounded-xl shadow p-16 text-center text-slate-400 border border-slate-100 flex flex-col items-center justify-center">
        <svg class="w-12 h-12 mb-4 text-slate-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
        İncelemek için sol menüden bir vaka seçin.
      </div>

      <div id="detail" class="hidden space-y-4">

        <div class="bg-white rounded-xl shadow p-5 border border-slate-100">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-xs text-slate-400 font-mono bg-slate-50 inline-block px-2 py-1 rounded" id="caseId"></div>
              <div class="text-xl font-bold text-slate-800 mt-2" id="patientName"></div>
              <div class="text-sm text-slate-500 mt-0.5" id="patientMeta"></div>
            </div>
            <div class="flex gap-2 flex-shrink-0 mt-1">
              <button onclick="window.print()" class="rounded-lg border border-slate-300 px-4 py-2 text-xs font-medium text-slate-700 hover:bg-slate-50 transition-colors">⎙ Raporu Yazdır</button>
              <button id="saveBtn" class="rounded-lg bg-black text-white px-4 py-2 text-xs font-semibold hover:bg-slate-800 transition-colors shadow-sm">Klinik Kararı Kaydet</button>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow p-5 border-l-4 border-blue-400">
          <h3 class="font-semibold text-slate-800 mb-4">Hasta Beyanı <span class="text-xs font-normal text-slate-400 ml-1">(Hasta tarafından doldurulan ham veriler)</span></h3>
          <div id="patientDeclaration" class="text-sm text-slate-700"></div>
        </div>

        <div class="bg-white rounded-xl shadow p-5 border-l-4 border-rose-400">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-slate-800">Klinik Risk Motoru Çıktıları</h3>
            <span id="flagCount" class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded font-mono"></span>
          </div>
          <div id="flags" class="flex flex-col gap-2 mb-3"></div>
          <p class="text-xs text-slate-400 border-t border-slate-100 pt-3 mt-2">
            <strong class="text-rose-500">HARD</strong> = Majör Risk (Kontrendikasyon) &middot; 
            <strong class="text-amber-500">SOFT</strong> = İhtiyati Risk &middot; 
            <strong class="text-blue-500">VERIFY</strong> = Klinisyen onayı bekleniyor
          </p>
        </div>

        <div class="bg-white rounded-xl shadow p-5 border-l-4 border-emerald-400">
          <h3 class="font-semibold text-slate-800 mb-5">Klinisyen Doğrulama ve Bulgular (CV)</h3>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
              <label class="text-xs text-slate-500 uppercase tracking-wider font-semibold">Klinisyen Adı *</label>
              <input id="clinicianName" class="mt-1.5 w-full rounded-lg border border-slate-200 p-2.5 text-sm focus:outline-none focus:border-emerald-400 focus:ring-1 focus:ring-emerald-400" placeholder="Örn: Dr. Ahmet Yılmaz" />
            </div>
            <div>
              <label class="text-xs text-slate-500 uppercase tracking-wider font-semibold">Preoperatif ASA Sınıfı *</label>
              <select id="cv-asa" onchange="rerunFlags()" class="mt-1.5 w-full rounded-lg border border-slate-200 p-2.5 text-sm focus:outline-none focus:border-emerald-400">
                <option value="">Seçiniz...</option>
                <option value="1">ASA I — Normal sağlıklı hasta</option>
                <option value="2">ASA II — Hafif sistemik hastalık</option>
                <option value="3">ASA III — Ciddi sistemik hastalık</option>
                <option value="4">ASA IV — Hayatı tehdit eden sistemik hastalık</option>
              </select>
            </div>
            <div>
              <label class="text-xs text-slate-500 uppercase tracking-wider font-semibold">Sigara Durumu (Doğrulanan)</label>
              <div class="text-xs text-slate-400 mb-1.5">Hasta Beyanı: <span id="pr-smoking" class="font-medium text-slate-600"></span></div>
              <select id="cv-smoking" onchange="rerunFlags()" class="w-full rounded-lg border border-slate-200 p-2.5 text-sm focus:outline-none focus:border-emerald-400">
                <option value="">Doğrulama bekliyor</option>
                <option value="never">Hiç içmemiş</option>
                <option value="quit_6m_plus">Bırakmış — >6 ay</option>
                <option value="quit_recent">Bırakmış — <6 ay</option>
                <option value="active">Aktif içici</option>
              </select>
            </div>
            <div>
              <label class="text-xs text-slate-500 uppercase tracking-wider font-semibold">Kan Sulandırıcı Durumu</label>
              <div class="text-xs text-slate-400 mb-1.5">Hasta Beyanı: <span id="pr-anticoag" class="font-medium text-slate-600"></span></div>
              <select id="cv-anticoag" onchange="rerunFlags()" class="w-full rounded-lg border border-slate-200 p-2.5 text-sm focus:outline-none focus:border-emerald-400">
                <option value="">Doğrulama bekliyor</option>
                <option value="none">Kullanmıyor</option>
                <option value="paused">Kesildi (Preop protokol uygulandı)</option>
                <option value="active">Aktif kullanım</option>
              </select>
            </div>
            <div>
              <label class="text-xs text-slate-500 uppercase tracking-wider font-semibold">Ölçülen BMI</label>
              <div class="text-xs text-slate-400 mb-1.5">Hesaplanan Beyan: <span id="pr-bmi" class="font-medium text-slate-600"></span></div>
              <input type="number" id="cv-bmi" step="0.1" min="10" max="80" onchange="rerunFlags()" class="w-full rounded-lg border border-slate-200 p-2.5 text-sm focus:outline-none focus:border-emerald-400" placeholder="Klinikte ölçülen BMI (Örn: 24.5)" />
            </div>
            <div>
              <label class="text-xs text-slate-500 uppercase tracking-wider font-semibold">Ek Muayene Notu (Opsiyonel)</label>
              <div class="text-xs text-transparent mb-1.5 select-none">Boşluk</div>
              <input id="examNote" class="w-full rounded-lg border border-slate-200 p-2.5 text-sm focus:outline-none focus:border-emerald-400" placeholder="Fizik muayene veya konsültasyon notu..." />
            </div>
          </div>

          <div class="mt-6 rounded-lg bg-slate-50 border border-slate-200 p-4">
            <div class="text-xs text-slate-500 uppercase tracking-wider font-bold mb-3">Medikolegal Kapatma Onayları</div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-3 gap-x-4 text-sm">
              <label class="flex items-center gap-2 cursor-pointer text-slate-700 hover:text-black"><input type="checkbox" id="v_smoking" class="accent-black h-4 w-4" /> Sigara/Alışkanlık riski teyit edildi</label>
              <label class="flex items-center gap-2 cursor-pointer text-slate-700 hover:text-black"><input type="checkbox" id="v_meds" class="accent-black h-4 w-4" /> İlaç etkileşimleri değerlendirildi</label>
              <label class="flex items-center gap-2.5 cursor-pointer sm:col-span-2 font-medium text-emerald-900 bg-emerald-50/50 border border-emerald-200 p-2.5 rounded hover:bg-emerald-50 transition-colors">
                <input type="checkbox" id="v_labs" class="accent-emerald-600 h-5 w-5 flex-shrink-0" /> 
                <span>Preoperatif laboratuvar ve anestezi tetkikleri incelendi, hasta beyanıyla uyumlu bulundu.</span>
              </label>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow p-5 border border-slate-100">
          <h3 class="font-semibold text-slate-800 mb-4">Nihai Klinik Karar</h3>

          <div id="gateSuggestion" class="hidden mb-5 rounded-lg p-3.5 text-sm border font-medium"></div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
              <label class="text-xs text-slate-500 uppercase tracking-wider font-semibold">Karar *</label>
              <select id="decision" onchange="updateReportPreview()" class="mt-1.5 w-full rounded-lg border border-slate-200 p-2.5 text-sm focus:outline-none focus:border-blue-400 font-medium text-slate-800">
                <option value="" disabled selected>Seçiniz...</option>
                <option value="suitable">✓ Operasyona Uygun (Clearance)</option>
                <option value="conditional">◐ Şartlı Uygun (Konsültasyon Gerektirir)</option>
                <option value="not_suitable">✗ Uygun Değil / İptal</option>
              </select>
            </div>
            <div class="md:col-span-1">
              <label class="text-xs text-slate-500 uppercase tracking-wider font-semibold">Tıbbi Gerekçe (Rationale) *</label>
              <textarea id="rationale" rows="3" onchange="updateReportPreview()" class="mt-1.5 w-full rounded-lg border border-slate-200 p-2.5 text-sm focus:outline-none focus:border-blue-400" placeholder="Karar gerekçesi, şartlar veya laboratuvar uyumsuzluğu varsa belirtiniz..."></textarea>
            </div>
          </div>
        </div>

        <div id="printArea">
          <div class="bg-white rounded-xl shadow p-8 border border-slate-200">
            <div class="flex items-start justify-between mb-6 pb-4 border-b border-slate-200">
              <div>
                <img src="logo.png" alt="SurgiCheck" class="h-10 mb-3 object-contain" />
                <div class="text-lg font-bold uppercase tracking-wider text-slate-800">Preoperatif Uygunluk Raporu</div>
                <div class="text-sm font-medium text-slate-500">Leo Klinik</div>
              </div>
              <div class="text-xs text-slate-500 text-right mt-14">
                <div id="reportTimestamp" class="font-medium"></div>
                <div id="reportCaseId" class="font-mono mt-0.5 text-slate-400"></div>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-y-3 gap-x-4 text-sm mb-6 bg-slate-50 p-4 rounded-lg border border-slate-100">
              <div><span class="text-slate-500 w-24 inline-block">Hasta:</span> <span id="r_patient" class="font-bold text-slate-800"></span></div>
              <div><span class="text-slate-500 w-24 inline-block">Prosedür:</span> <span id="r_procedure" class="font-bold text-slate-800"></span></div>
              <div><span class="text-slate-500 w-24 inline-block">Ölçülen BMI:</span> <span id="r_bmi" class="font-medium"></span></div>
              <div><span class="text-slate-500 w-24 inline-block">ASA Skoru:</span> <span id="r_asa" class="font-bold text-slate-800"></span></div>
            </div>

            <div class="mb-5">
              <div class="text-xs text-slate-500 uppercase tracking-wider mb-2 font-bold border-b pb-1">Tespit Edilen Riskler ve Etkileşimler</div>
              <div id="r_flags" class="flex flex-col gap-1.5 text-slate-800"></div>
            </div>

            <div id="r_lab_status" class="text-sm mb-5 text-emerald-800 bg-emerald-50 border border-emerald-200 p-2.5 rounded font-medium hidden flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
              Laboratuvar ve preoperatif anestezi tetkikleri klinisyen tarafından kontrol edilmiştir.
            </div>

            <div id="r_decision_box" class="rounded-lg p-3.5 mb-5 border text-base font-bold text-center uppercase tracking-widest shadow-sm" style="display:none"></div>

            <div class="text-sm bg-slate-50/50 p-4 rounded border border-slate-200">
              <div class="text-xs text-slate-500 uppercase tracking-wider mb-1.5 font-bold">Klinisyen Gerekçesi ve Notlar</div>
              <div id="r_rationale" class="whitespace-pre-wrap text-slate-800 italic"></div>
            </div>

            <div class="mt-10 pt-4 border-t border-slate-200 text-xs text-slate-400 text-justify leading-relaxed flex justify-between items-end">
              <div class="w-2/3">
                Bu belge bir klinik karar destek aracı yardımıyla oluşturulmuştur. Risk tespiti, operasyon onayı ve laboratuvar sonuçlarının nihai değerlendirmesi süreci bizzat yöneten klinisyene aittir. Hastanın hukuki dijital onayı sistemde kayıtlıdır.
              </div>
              <div class="w-1/3 text-right">
                <div class="mb-6 text-slate-300">İmza</div>
                <div id="r_clinician_sig" class="font-bold text-sm text-black uppercase tracking-wide"></div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, collection, getDocs, doc, getDoc,
    updateDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB1j6BthE6pSHzqW82dVaphyD2IiI03LN8",
    authDomain: "surgicheck-v3.firebaseapp.com",
    projectId: "surgicheck-v3",
    storageBucket: "surgicheck-v3.firebasestorage.app",
    messagingSenderId: "907975258387",
    appId: "1:907975258387:web:6e26d8deddbd8f52e22ae6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ─── FARMAKOLOJİK KURAL MOTORU ───────────────────────────────────────────
  function computeFlags(caseData, cvOverrides = {}) {
    const flags = [];
    try {
      const r = caseData?.risks ?? {};
      const bmi = cvOverrides.bmi ?? caseData?.anthropometrics?.bmi ?? null;
      const proc = caseData?.procedure?.name ?? "";
      const asa = cvOverrides.asa ?? caseData?.clinician?.asa ?? null;
      const smokingCV = cvOverrides.smokingVerified ?? caseData?.clinician?.smokingVerified ?? null;
      const anticoagCV = cvOverrides.anticoagVerified ?? caseData?.clinician?.anticoagVerified ?? null;

      // 1. Genel Kontrendikasyonlar
      if (asa === "4") flags.push({ type: "HARD", key: "asa4", title: "ASA IV", desc: "Elektif cerrahi kontrendike." });
      if (r.activeMalignancy) flags.push({ type: "HARD", key: "malignancy", title: "Aktif Malignite", desc: "Onkoloji konsültasyonu zorunlu." });
      if (r.dvt) flags.push({ type: "HARD", key: "dvt", title: "DVT / PE Geçmişi", desc: "Tromboprofilaksi planı zorunlu." });

      // 2. İlaç Etkileşimleri
      if (anticoagCV === "active") {
        flags.push({ type: "HARD", key: "anticoag_active", title: "Aktif Kan Sulandırıcı", desc: "Bridging protokolü uygulanmalıdır." });
      } else if (!anticoagCV && (r.medBloodThinners || r.anticoagulant)) {
        flags.push({ type: "VERIFY", key: "anticoag_verify", title: "Kan Sulandırıcı — CV Gerekli", desc: "Hastanın beyanı doğrulanmalı." });
      }

      if (r.medGlp1) flags.push({ type: "HARD", key: "med_glp1", title: "İlaç Etkileşimi: GLP-1", desc: "Aspirasyon riski. Ameliyat öncesi kesilmeli." });
      
      if (r.medOcp) {
        const highDvtProcs = ["Tummy Tuck", "BBL", "Liposuction", "Breast Lift", "Meme Küçültme"];
        if (highDvtProcs.some(p => proc.includes(p))) {
          flags.push({ type: "SOFT", key: "med_ocp_dvt", title: "İlaç Etkileşimi: OKS + Majör Cerrahi", desc: "Tromboemboli (DVT) riski artışı." });
        } else {
          flags.push({ type: "SOFT", key: "med_ocp", title: "İlaç: Doğum Kontrol / Hormon", desc: "DVT risk profiline eklenmeli." });
        }
      }

      if (r.medAcne) flags.push({ type: "SOFT", key: "med_acne", title: "İlaç Etkileşimi: İzotretinoin", desc: "Gecikmiş yara iyileşmesi ve skar riski." });
      if (r.medPsych || r.psych) flags.push({ type: "SOFT", key: "med_psych", title: "Psikiyatrik Öykü", desc: "Beden Dismorfik Bozukluğu (BDD) ihtimali." });
      if (r.medSteroid) flags.push({ type: "VERIFY", key: "med_steroid", title: "İlaç: Steroid", desc: "Adrenal süpresyon riski." });

      // 3. BMI ve Alışkanlıklar
      if (smokingCV === "active") {
        flags.push({ type: "SOFT", key: "smoking_active", title: "Aktif Sigara", desc: "Flep nekrozu riski çok yüksek." });
      } else if (!smokingCV && r.smoking === "active") {
        flags.push({ type: "VERIFY", key: "smoking_verify", title: "Sigara — CV Gerekli", desc: "Aktif içici beyanı." });
      }

      const highBmiProcs = ["Tummy Tuck", "BBL", "Liposuction", "Meme Küçültme"];
      const isHBP = highBmiProcs.some(p => proc.includes(p));
      if (bmi !== null) {
        if (bmi >= 40 && isHBP) flags.push({ type: "HARD", key: "bmi40", title: `BMI ≥ 40`, desc: "Elektif vücut şekillendirme ertelenmeli." });
        else if (bmi >= 35 && isHBP) flags.push({ type: "SOFT", key: "bmi35", title: `BMI 35–39`, desc: "Yüksek operasyonel risk." });
      } else {
        flags.push({ type: "VERIFY", key: "bmi_missing", title: "BMI — Ölçüm Girilmedi", desc: "Risk analizi için ölçüm gerekli." });
      }

      // 4. Komorbidite ve Cerrahi Geçmiş
      if (r.keloid) flags.push({ type: "SOFT", key: "keloid", title: "Kötü Skar", desc: "Revizyon/Skar onamı alınmalı." });
      if (r.csection && proc === "Tummy Tuck") flags.push({ type: "SOFT", key: "csection", title: "Geçirilmiş Batın Cerrahisi", desc: "Fasyal anatomi defekti." });
      if (caseData?.procedure?.revision) flags.push({ type: "SOFT", key: "revision", title: "Revizyon Cerrahisi", desc: "Anatomik plan zorluğu." });
    } catch (e) {
      console.error("Kural motoru hatası:", e);
    }
    return flags;
  }

  function gateFromFlags(flags) {
    if (flags.some(f => f.type === "HARD")) return "ineligible";
    if (flags.some(f => f.type === "VERIFY")) return "verify";
    if (flags.some(f => f.type === "SOFT")) return "conditional";
    return "eligible";
  }

  let casesCache = [];
  let selectedCaseId = null;
  let selectedCase = null;

  function showAlert(type, msg) {
    const el = document.getElementById("alert");
    el.classList.remove("hidden");
    el.className = "mb-4 rounded-lg p-3 text-sm font-semibold " + (type === "ok" ? "bg-emerald-50 text-emerald-800 border border-emerald-200" : "bg-rose-50 text-rose-800 border border-rose-200");
    el.textContent = msg;
    setTimeout(() => el.classList.add("hidden"), 3500);
  }

  async function fetchCases() {
    try {
      const el = document.getElementById("caseList");
      el.innerHTML = `<div class="text-sm text-slate-400 py-8 text-center animate-pulse">Veriler çekiliyor...</div>`;
      
      const snap = await getDocs(collection(db, "cases"));
      const rows = [];
      snap.forEach(d => rows.push({ id: d.id, ...d.data() }));
      rows.sort((a, b) => (b.createdAt?.seconds ?? 0) - (a.createdAt?.seconds ?? 0));
      casesCache = rows;
      applySearch();
    } catch (err) {
      console.error("Firebase Hatası:", err);
      document.getElementById("caseList").innerHTML = `<div class="text-sm text-rose-600 py-3 px-2 border border-rose-200 bg-rose-50 rounded mt-2 font-medium">Bağlantı Hatası. Konsolu kontrol edin.</div>`;
    }
  }

  function applySearch() {
    try {
      const q = (document.getElementById("searchBox").value || "").toLowerCase().trim();
      const filtered = q
        ? casesCache.filter(c => [c.patient?.fullName, c.procedure?.name].join(" ").toLowerCase().includes(q))
        : casesCache;
      renderCaseList(filtered);
    } catch (e) {}
  }

  function renderCaseList(items) {
    const el = document.getElementById("caseList");
    if (!items.length) { el.innerHTML = `<div class="text-sm text-slate-400 py-4 text-center">Vaka bulunamadı.</div>`; return; }
    el.innerHTML = "";
    items.forEach(c => {
      try {
        const flags = computeFlags(c);
        const hardCount = flags.filter(f => f.type === "HARD").length;
        const decMap = { suitable: "Uygun", conditional: "Şartlı", not_suitable: "İptal/Red" };
        const decColor = c.clinician?.decision === "suitable" ? "text-emerald-600 font-bold" : c.clinician?.decision === "not_suitable" ? "text-rose-600 font-bold" : "text-slate-500";
        
        const btn = document.createElement("button");
        btn.className = "w-full text-left rounded-lg border border-slate-200 p-3 hover:bg-slate-50 transition-colors" + (c.id === selectedCaseId ? " bg-blue-50/50 border-blue-300 ring-1 ring-blue-300" : "");
        btn.innerHTML = `
          <div class="flex items-start justify-between gap-2">
            <div>
              <div class="text-sm font-bold text-slate-800">${c.patient?.fullName ?? "İsimsiz Vaka"}</div>
              <div class="text-xs text-slate-500 mt-0.5">${c.procedure?.name ?? "—"}</div>
              <div class="text-xs mt-1">Karar: <span class="${decColor}">${decMap[c.clinician?.decision] ?? "Bekliyor"}</span></div>
            </div>
            <div class="flex flex-col items-end gap-1.5 mt-0.5">
              ${hardCount > 0 ? `<span class="text-[10px] uppercase bg-rose-100 text-rose-700 font-bold border border-rose-200 rounded px-1.5 py-0.5">${hardCount} HARD</span>` : ""}
              ${flags.length > 0 ? `<span class="text-[10px] uppercase text-slate-400 font-medium">${flags.length} Flag</span>` : ""}
            </div>
          </div>`;
        btn.addEventListener("click", () => loadCase(c.id));
        el.appendChild(btn);
      } catch (e) {}
    });
  }

  async function loadCase(id) {
    selectedCaseId = id;
    const snap = await getDoc(doc(db, "cases", id));
    if (!snap.exists()) { showAlert("err", "Vaka bulunamadı."); return; }
    selectedCase = { id: snap.id, ...snap.data() };

    document.getElementById("emptyState").classList.add("hidden");
    document.getElementById("detail").classList.remove("hidden");

    document.getElementById("caseId").textContent = selectedCase.id;
    document.getElementById("patientName").textContent = selectedCase.patient?.fullName ?? "—";
    document.getElementById("patientMeta").textContent = `${selectedCase.patient?.age ?? "?"} yaş · Tel: ${selectedCase.patient?.phone ?? ""} · ${selectedCase.patient?.email ?? ""}`;

    const a = selectedCase.anthropometrics ?? {};
    const r = selectedCase.risks ?? {};
    
    const medsList = [];
    if(r.medBloodThinners) medsList.push("Kan Sulandırıcı");
    if(r.medOcp) medsList.push("Doğum Kontrol");
    if(r.medGlp1) medsList.push("Zayıflama(GLP1)");
    if(r.medAcne) medsList.push("Akne(İzotretinoin)");
    if(r.medPsych) medsList.push("Psikiyatrik");
    if(r.medSteroid) medsList.push("Steroid");
    const medsText = medsList.length > 0 ? medsList.join(", ") : "Yok";

    document.getElementById("patientDeclaration").innerHTML = `
      <div class="grid grid-cols-2 md:grid-cols-3 gap-y-3 gap-x-4 text-slate-700">
        <div><span class="text-slate-400 block text-xs uppercase tracking-wide mb-0.5">Prosedür</span> <span class="font-bold">${selectedCase.procedure?.name ?? "—"}</span></div>
        <div><span class="text-slate-400 block text-xs uppercase tracking-wide mb-0.5">Boy / Kilo / Beyan BMI</span> ${a.heightCm ?? "?"}cm / ${a.weightKg ?? "?"}kg / <span class="font-medium">${a.bmi ?? "?"}</span></div>
        <div><span class="text-slate-400 block text-xs uppercase tracking-wide mb-0.5">Sigara</span> <span class="${r.smoking === "active" ? "text-rose-600 font-bold" : "font-medium"}">${r.smoking ?? "—"}</span></div>
        
        <div class="col-span-2 md:col-span-3 border-t border-slate-100 my-1"></div>
        
        <div><span class="text-slate-400 block text-xs uppercase tracking-wide mb-0.5">Majör İlaçlar</span> <span class="${medsList.length > 0 ? "text-amber-600 font-bold" : "font-medium"}">${medsText}</span></div>
        <div class="col-span-2"><span class="text-slate-400 block text-xs uppercase tracking-wide mb-0.5">Diğer Belirtilen İlaçlar</span> <span class="italic text-slate-600">${r.medOther || "Belirtilmemiş"}</span></div>
        
        <div class="col-span-2 md:col-span-3 border-t border-slate-100 my-1"></div>
        
        <div><span class="text-slate-400 block text-xs uppercase tracking-wide mb-0.5">Kardiyak/HT/DM</span> ${(r.cardiac || r.ht || r.diabetes) ? "<span class='font-bold text-amber-600'>Var</span>" : "Yok"}</div>
        <div><span class="text-slate-400 block text-xs uppercase tracking-wide mb-0.5">DVT/PE/Malignite</span> <span class="${(r.dvt || r.activeMalignancy) ? "text-rose-600 font-bold" : ""}">${(r.dvt || r.activeMalignancy) ? "Var ⚠" : "Yok"}</span></div>
        <div><span class="text-slate-400 block text-xs uppercase tracking-wide mb-0.5">Keloid Skar</span> <span class="${r.keloid ? "text-amber-600 font-bold" : ""}">${r.keloid ? "Var" : "Yok"}</span></div>
      </div>
      
      <div class="mt-4 text-sm text-slate-600 bg-slate-50 p-3 rounded-lg border border-slate-100">
        <div class="mb-2"><strong class="text-slate-500">Geçmiş:</strong> ${selectedCase.medHistory || "—"}</div>
        <div><strong class="text-slate-500">Beklenti:</strong> ${selectedCase.expectations || "—"}</div>
        <div class="mt-2 text-xs text-emerald-600 font-medium">${selectedCase.legalConsentVerified ? "✓ Hukuki beyan ve onay dijital olarak alınmıştır." : "⚠ Hukuki onay kaydı eksik."}</div>
      </div>
    `;

    document.getElementById("pr-smoking").textContent = r.smoking ?? "—";
    document.getElementById("pr-anticoag").textContent = r.medBloodThinners || r.anticoagulant ? "Kullanıyor" : "Yok";
    document.getElementById("pr-bmi").textContent = a.bmi ?? "—";

    const cl = selectedCase.clinician ?? {};
    document.getElementById("clinicianName").value = cl.name ?? "";
    document.getElementById("cv-asa").value = cl.asa ?? "";
    document.getElementById("cv-smoking").value = cl.smokingVerified ?? "";
    document.getElementById("cv-anticoag").value = cl.anticoagVerified ?? "";
    document.getElementById("cv-bmi").value = cl.bmiMeasured ?? "";
    document.getElementById("examNote").value = cl.examNote ?? "";
    
    const v = cl.validations ?? {};
    document.getElementById("v_smoking").checked = !!v.smoking;
    document.getElementById("v_meds").checked = !!v.meds;
    document.getElementById("v_labs").checked = !!v.labs;

    document.getElementById("decision").value = cl.decision ?? "";
    document.getElementById("rationale").value = cl.rationale ?? "";

    renderCurrentFlags();
    window.updateReportPreview(); // Referans hatasını çözen önceden tanımlanmış fonksiyon kullanımı
    applySearch();
  }

  function getCVOverrides() {
    return {
      asa: document.getElementById("cv-asa").value || null,
      smokingVerified: document.getElementById("cv-smoking").value || null,
      anticoagVerified: document.getElementById("cv-anticoag").value || null,
      bmi: parseFloat(document.getElementById("cv-bmi").value) || null,
    };
  }

  function renderCurrentFlags() {
    if (!selectedCase) return;
    const flags = computeFlags(selectedCase, getCVOverrides());
    const el = document.getElementById("flags");
    document.getElementById("flagCount").textContent = flags.length + " Kural Tetiklendi";
    el.innerHTML = "";

    if (!flags.length) {
      el.innerHTML = `<div class="p-3 rounded-lg border border-emerald-300 text-emerald-800 bg-emerald-50 font-medium flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Sistemik majör risk tespit edilmedi.</div>`;
    } else {
      flags.forEach(f => {
        const cls = f.type === "HARD" ? "border-rose-300 text-rose-800 bg-rose-50 font-bold"
          : f.type === "SOFT" ? "border-amber-300 text-amber-800 bg-amber-50"
          : "border-blue-300 text-blue-800 bg-blue-50";
        el.innerHTML += `<div class="text-sm p-3 rounded-lg border ${cls} w-full flex flex-col sm:flex-row justify-between sm:items-center gap-1 shadow-sm">
          <span><strong class="uppercase tracking-wide opacity-80 mr-1">[${f.type}]</strong> ${f.title}</span> 
          <span class="text-xs opacity-90 sm:text-right font-normal">${f.desc}</span>
        </div>`;
      });
    }

    const gate = gateFromFlags(flags);
    const sug = document.getElementById("gateSuggestion");
    const gateMap = {
      eligible: { text: "Rutin preoperatif süreç işletilebilir.", cls: "bg-emerald-50 border-emerald-200 text-emerald-800" },
      conditional: { text: "Dikkat! Şartlı onay veya ek hazırlık önerilir.", cls: "bg-amber-50 border-amber-200 text-amber-800" },
      verify: { text: "Karar öncesi klinisyen doğrulaması (CV) tamamlanmalıdır.", cls: "bg-blue-50 border-blue-200 text-blue-800" },
      ineligible: { text: "MAJÖR RİSK! Ek konsültasyon veya red kararı önerilir.", cls: "bg-rose-50 border-rose-200 text-rose-800" },
    };
    sug.classList.remove("hidden");
    sug.className = `mb-5 rounded-lg p-3.5 text-sm border font-semibold flex items-center gap-2 ${gateMap[gate].cls}`;
    sug.innerHTML = `<svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Sistem Önerisi: ${gateMap[gate].text}`;
  }

  // ÖNEMLİ DÜZELTME: updateReportPreview fonksiyonu Listener'lardan ÖNCE tanımlanıyor.
  window.updateReportPreview = function() {
    if (!selectedCase) return;
    const flags = computeFlags(selectedCase, getCVOverrides());
    const cvBmi = document.getElementById("cv-bmi").value;
    const asa = document.getElementById("cv-asa").value;
    const dec = document.getElementById("decision").value;
    const labsVerified = document.getElementById("v_labs").checked;

    document.getElementById("reportTimestamp").textContent = new Date().toLocaleString("tr-TR");
    document.getElementById("reportCaseId").textContent = selectedCase.id;
    document.getElementById("r_patient").textContent = `${selectedCase.patient?.fullName ?? "—"} (${selectedCase.patient?.age ?? "?"}y)`;
    document.getElementById("r_procedure").textContent = `${selectedCase.procedure?.name ?? "—"}`;
    document.getElementById("r_bmi").textContent = cvBmi ? cvBmi + " kg/m²" : (selectedCase.anthropometrics?.bmi ?? "—") + " (beyan)";
    document.getElementById("r_asa").textContent = asa ? "ASA " + asa : "Belirtilmemiş";
    document.getElementById("r_rationale").textContent = document.getElementById("rationale").value || "Gerekçe girilmemiş.";
    document.getElementById("r_clinician_sig").textContent = document.getElementById("clinicianName").value ? `Dr. ${document.getElementById("clinicianName").value}` : "İmza";

    const rfl = document.getElementById("r_flags");
    rfl.innerHTML = flags.length
      ? flags.map(f => `<div class="text-sm border-b border-slate-100 pb-1.5 pt-1"><strong class="text-slate-800">[${f.type}] ${f.title}:</strong> <span class="text-slate-600">${f.desc}</span></div>`).join("")
      : "<div class='text-sm text-slate-500 italic'>Sistemik majör risk bayrağı tespit edilmedi.</div>";

    const labStatusBox = document.getElementById("r_lab_status");
    labsVerified ? labStatusBox.classList.remove("hidden") : labStatusBox.classList.add("hidden");

    const db2 = document.getElementById("r_decision_box");
    if (dec) {
      db2.style.display = "block";
      const decMap = {
        suitable: { text: "✓ OPERASYONA UYGUN (CLEARANCE GIVEN)", cls: "bg-emerald-50 border-emerald-300 text-emerald-800" },
        conditional: { text: "◐ ŞARTLI UYGUN (KONSÜLTASYON/EK TEDAVİ)", cls: "bg-amber-50 border-amber-300 text-amber-800" },
        not_suitable: { text: "✗ UYGUN DEĞİL / İPTAL (NOT CLEARED)", cls: "bg-rose-50 border-rose-300 text-rose-800" }
      };
      db2.className = `rounded-lg p-3.5 mb-5 border text-base font-bold text-center uppercase tracking-widest shadow-sm ${decMap[dec].cls}`;
      db2.textContent = decMap[dec].text;
    } else {
      db2.style.display = "none";
    }
  };

  // Dinleyiciler fonksiyon tanımlandıktan SONRA atanıyor.
  window.rerunFlags = function() { renderCurrentFlags(); window.updateReportPreview(); };
  document.getElementById("v_labs").addEventListener("change", window.updateReportPreview);

  document.getElementById("saveBtn").addEventListener("click", async () => {
    if (!selectedCaseId) return;
    
    // VERIFY Bloker
    const currentFlags = computeFlags(selectedCase, getCVOverrides());
    if (currentFlags.some(f => f.type === "VERIFY")) { 
      showAlert("err", "Kayıt öncesi lütfen 'VERIFY' (Doğrulama Bekliyor) uyarılarını teyit edin."); 
      return; 
    }
    
    const decision = document.getElementById("decision").value;
    if (!decision) { showAlert("err", "Lütfen Nihai Karar seçiniz."); return; }
    if (!document.getElementById("clinicianName").value.trim()) { showAlert("err", "Klinisyen adı zorunludur."); return; }

    // Uygun kararı verilmişse Lab uyarısı
    if (decision === "suitable" && !document.getElementById("v_labs").checked) {
      const isSure = confirm("Laboratuvar tetkik onayı kutusu İŞARETLENMEMİŞ. Yine de vaka onayını kaydetmek istiyor musunuz?");
      if(!isSure) return;
    }

    try {
      const btn = document.getElementById("saveBtn");
      btn.disabled = true;
      btn.textContent = "Kaydediliyor...";

      await updateDoc(doc(db, "cases", selectedCaseId), {
        clinician: {
          name: document.getElementById("clinicianName").value.trim(),
          asa: document.getElementById("cv-asa").value || null,
          smokingVerified: document.getElementById("cv-smoking").value || null,
          anticoagVerified: document.getElementById("cv-anticoag").value || null,
          bmiMeasured: parseFloat(document.getElementById("cv-bmi").value) || null,
          examNote: document.getElementById("examNote").value.trim() || null,
          decision: decision,
          rationale: document.getElementById("rationale").value.trim() || null,
          validations: {
            smoking: document.getElementById("v_smoking").checked,
            meds: document.getElementById("v_meds").checked,
            labs: document.getElementById("v_labs").checked,
          }
        },
        status: "clinician_reviewed",
        updatedAt: serverTimestamp()
      });
      
      showAlert("ok", "Vaka kararı başarıyla kaydedildi.");
      btn.disabled = false;
      btn.textContent = "Klinik Kararı Kaydet";
      
      await fetchCases();
      await loadCase(selectedCaseId);
    } catch (err) {
      document.getElementById("saveBtn").disabled = false;
      document.getElementById("saveBtn").textContent = "Klinik Kararı Kaydet";
      showAlert("err", "Bağlantı hatası: Kaydedilemedi.");
    }
  });

  document.getElementById("refreshBtn").addEventListener("click", fetchCases);
  document.getElementById("searchBox").addEventListener("input", applySearch);
  
  // Modül yüklenir yüklenmez verileri çek
  fetchCases();
</script>

</body>
</html>
