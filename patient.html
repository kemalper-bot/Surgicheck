<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SurgiCheck | Hasta Ön Değerlendirme</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen">
  <div class="max-w-3xl mx-auto p-6">

    <div class="bg-white rounded-xl shadow p-6 mb-6">
      <div class="flex items-center justify-between border-b border-slate-100 pb-4">
        <div class="flex items-center gap-4">
          <img src="logo.png" alt="SurgiCheck Logo" class="h-12 md:h-16 object-contain" />
          <div class="hidden sm:block border-l border-slate-200 pl-4">
            <h1 class="text-xl font-bold text-slate-800 tracking-tight">Preoperatif Risk Analizi</h1>
            <p class="text-sm text-slate-500 font-medium">Leo Klinik</p>
          </div>
        </div>
        <div class="text-xs text-slate-400 text-right leading-relaxed bg-slate-50 p-2 rounded border border-slate-100 hidden md:block">
          Bu form tanı koymaz.<br/><span class="font-medium text-slate-500">Nihai karar klinisyene aittir.</span>
        </div>
      </div>

      <div class="mt-6">
        <div class="flex items-center gap-0">
          <div class="step-item flex items-center gap-2 flex-1">
            <div id="dot-1" class="w-7 h-7 rounded-full flex items-center justify-center text-xs font-semibold bg-black text-white flex-shrink-0">1</div>
            <div class="text-xs text-slate-600 hidden sm:block">Kişisel & Prosedür</div>
            <div class="flex-1 h-px bg-slate-200 mx-2"></div>
          </div>
          <div class="step-item flex items-center gap-2 flex-1">
            <div id="dot-2" class="w-7 h-7 rounded-full flex items-center justify-center text-xs font-semibold bg-slate-200 text-slate-500 flex-shrink-0">2</div>
            <div class="text-xs text-slate-400 hidden sm:block">Sağlık & İlaçlar</div>
            <div class="flex-1 h-px bg-slate-200 mx-2"></div>
          </div>
          <div class="step-item flex items-center gap-2 flex-1">
            <div id="dot-3" class="w-7 h-7 rounded-full flex items-center justify-center text-xs font-semibold bg-slate-200 text-slate-500 flex-shrink-0">3</div>
            <div class="text-xs text-slate-400 hidden sm:block">Alışkanlıklar</div>
            <div class="flex-1 h-px bg-slate-200 mx-2"></div>
          </div>
          <div class="step-item flex items-center gap-2">
            <div id="dot-4" class="w-7 h-7 rounded-full flex items-center justify-center text-xs font-semibold bg-slate-200 text-slate-500 flex-shrink-0">4</div>
            <div class="text-xs text-slate-400 hidden sm:block">Beklentiler & Onay</div>
          </div>
        </div>
      </div>
    </div>

    <div id="alert" class="hidden mb-4 rounded-lg p-3 text-sm"></div>

    <div id="sec-1" class="bg-white rounded-xl shadow p-6 mb-4">
      <h2 class="font-semibold text-lg mb-4">Kişisel Bilgiler ve Prosedür</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
          <label class="text-sm text-slate-600">Planlanan Prosedür *</label>
          <select id="procedure" class="mt-1 w-full rounded-lg border border-slate-200 p-2.5 text-sm focus:outline-none focus:border-slate-400">
            <option value="" disabled selected>Seçiniz...</option>
            <option value="Rinoplasti">Rinoplasti</option>
            <option value="Blefaroplasti">Blefaroplasti</option>
            <option value="Breast Lift">Breast Lift</option>
            <option value="Meme Büyütme">Meme Büyütme</option>
            <option value="Meme Küçültme">Meme Küçültme</option>
            <option value="Liposuction">Liposuction</option>
            <option value="Tummy Tuck">Tummy Tuck (Karın Germe)</option>
            <option value="BBL">BBL</option>
            <option value="Facelift">Facelift</option>
            <option value="Diğer">Diğer</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-slate-600">Aynı bölgede önceki ameliyat var mı? *</label>
          <select id="revision" class="mt-1 w-full rounded-lg border border-slate-200 p-2.5 text-sm focus:outline-none focus:border-slate-400">
            <option value="no">Hayır</option>
            <option value="yes">Evet — revizyon</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="text-sm text-slate-600">Ad Soyad *</label>
          <input id="fullName" class="mt-1 w-full rounded-lg border border-slate-200 p-2.5 text-sm focus:outline-none focus:border-slate-400" placeholder="Ad Soyad" />
        </div>
        <div>
          <label class="text-sm text-slate-600">Telefon *</label>
          <input id="phone" class="mt-1 w-full rounded-lg border border-slate-200 p-2.5 text-sm focus:outline-none focus:border-slate-400" placeholder="+90 5XX XXX XX XX" />
        </div>
        <div>
          <label class="text-sm text-slate-600">E-posta * <span class="text-xs text-slate-400">(Bilgilendirmeler için zorunlu)</span></label>
          <input id="email" type="email" class="mt-1 w-full rounded-lg border border-slate-200 p-2.5 text-sm focus:outline-none focus:border-slate-400" placeholder="email@ornek.com" />
        </div>
        <div>
          <label class="text-sm text-slate-600">Yaş *</label>
          <input id="age" type="number" min="16" max="100" class="mt-1 w-full rounded-lg border border-slate-200 p-2.5 text-sm focus:outline-none focus:border-slate-400" placeholder="35" />
        </div>
        <div>
          <label class="text-sm text-slate-600">Boy (cm) *</label>
          <input id="heightCm" type="number" min="1.20" step="any" class="mt-1 w-full rounded-lg border border-slate-200 p-2.5 text-sm focus:outline-none focus:border-slate-400" placeholder="Örn: 165 veya 1.65" />
        </div>
        <div>
          <label class="text-sm text-slate-600">Kilo (kg) *</label>
          <input id="weightKg" type="number" min="35" max="250" step="any" class="mt-1 w-full rounded-lg border border-slate-200 p-2.5 text-sm focus:outline-none focus:border-slate-400" placeholder="70" />
        </div>
      </div>
      <div id="bmi-display" class="hidden mt-3 rounded-lg bg-slate-50 border border-slate-200 p-3 text-sm text-slate-600">
        Hesaplanan BMI: <strong id="bmi-val" class="text-slate-800"></strong> <span id="bmi-note" class="text-slate-500"></span>
      </div>
      <div class="mt-6 flex justify-end">
        <button onclick="nextStep(1)" class="rounded-lg bg-black text-white px-5 py-2 text-sm font-medium hover:bg-slate-800">Devam →</button>
      </div>
    </div>

    <div id="sec-2" class="hidden bg-white rounded-xl shadow p-6 mb-4">
      <h2 class="font-semibold text-lg mb-1">Sağlık Geçmişi ve İlaçlar</h2>
      <p class="text-sm text-slate-500 mb-5">Operasyon risklerini değerlendirmemiz için lütfen eksiksiz doldurun.</p>

      <div class="space-y-6">
        
        <div class="rounded-lg border border-blue-200 bg-blue-50/50 p-4">
          <label class="text-sm font-medium text-slate-800">Düzenli Kullanılan İlaç Grupları</label>
          <p class="text-xs text-slate-500 mb-3">Aşağıdaki ilaç gruplarından herhangi birini kullanıyorsanız işaretleyiniz:</p>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-2">
            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="med_bloodThinners" class="accent-blue-600 w-4 h-4" /> <span class="text-sm">Kan Sulandırıcı (Aspirin, Coraspin, Plavix vb.)</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="med_ocp" class="accent-blue-600 w-4 h-4" /> <span class="text-sm">Doğum Kontrol / Hormon (Yazz, Microgynon vb.)</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="med_glp1" class="accent-blue-600 w-4 h-4" /> <span class="text-sm">Zayıflama İğnesi/İlacı (Ozempic, Saxenda vb.)</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="med_acne" class="accent-blue-600 w-4 h-4" /> <span class="text-sm">Ağır Akne İlacı (Roaccutane, Zoretanin vb.)</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="med_psych" class="accent-blue-600 w-4 h-4" /> <span class="text-sm">Psikiyatrik İlaç (Antidepresan, Xanax vb.)</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="med_steroid" class="accent-blue-600 w-4 h-4" /> <span class="text-sm">Kortizon / Steroid Tedavisi</span></label>
          </div>
          <div class="mt-4">
            <label class="text-xs text-slate-600">Diğer Düzenli İlaçlar / Takviyeler</label>
            <input id="med_other" class="mt-1 w-full rounded-lg border border-slate-300 p-2 text-sm focus:outline-none focus:border-slate-400 bg-white" placeholder="Tansiyon, tiroid ilaçları, vitaminler vb. isimlerini yazınız..." />
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="rounded-lg border border-slate-200 p-3">
            <label class="text-sm font-medium text-slate-700">Kardiyak Hastalık</label>
            <p class="text-xs text-slate-400 mb-2">Kalp yetmezliği, kapak hastalığı, kriz vb.</p>
            <div class="flex gap-3">
              <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="cardiac" value="no" checked class="accent-black" /> <span class="text-sm">Hayır</span></label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="cardiac" value="yes" class="accent-black" /> <span class="text-sm">Evet</span></label>
            </div>
          </div>

          <div class="rounded-lg border border-slate-200 p-3">
            <label class="text-sm font-medium text-slate-700">DVT / Pulmoner Emboli</label>
            <p class="text-xs text-slate-400 mb-2">Derin ven trombozu veya akciğer pıhtısı geçmişi</p>
            <div class="flex gap-3">
              <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="dvt" value="no" checked class="accent-black" /> <span class="text-sm">Hayır</span></label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="dvt" value="yes" class="accent-black" /> <span class="text-sm">Evet</span></label>
            </div>
          </div>

          <div class="rounded-lg border border-slate-200 p-3">
            <label class="text-sm font-medium text-slate-700">Diyabet</label>
            <p class="text-xs text-slate-400 mb-2">Tip 1 veya Tip 2</p>
            <div class="flex gap-3">
              <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="diabetes" value="no" checked class="accent-black" /> <span class="text-sm">Hayır</span></label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="diabetes" value="yes" class="accent-black" /> <span class="text-sm">Evet</span></label>
            </div>
          </div>

          <div class="rounded-lg border border-slate-200 p-3">
            <label class="text-sm font-medium text-slate-700">Hipertansiyon</label>
            <p class="text-xs text-slate-400 mb-2">Tanı konulmuş tansiyon yüksekliği</p>
            <div class="flex gap-3">
              <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="ht" value="no" checked class="accent-black" /> <span class="text-sm">Hayır</span></label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="ht" value="yes" class="accent-black" /> <span class="text-sm">Evet</span></label>
            </div>
          </div>

          <div class="rounded-lg border border-slate-200 p-3">
            <label class="text-sm font-medium text-slate-700">Aktif Malignite</label>
            <p class="text-xs text-slate-400 mb-2">Devam eden kanser tedavisi</p>
            <div class="flex gap-3">
              <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="malignancy" value="no" checked class="accent-black" /> <span class="text-sm">Hayır</span></label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="malignancy" value="yes" class="accent-black" /> <span class="text-sm">Evet</span></label>
            </div>
          </div>

          <div class="rounded-lg border border-slate-200 p-3">
            <label class="text-sm font-medium text-slate-700">Kötü Yara İyileşmesi (Skar)</label>
            <p class="text-xs text-slate-400 mb-2">Önceki kesilerde keloid, kabarık veya genişlemiş iz</p>
            <div class="flex gap-3">
              <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="keloid" value="no" checked class="accent-black" /> <span class="text-sm">Hayır</span></label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="keloid" value="yes" class="accent-black" /> <span class="text-sm">Evet</span></label>
            </div>
          </div>
        </div>

        <div id="dynamic-tummy" class="hidden rounded-lg border border-amber-200 bg-amber-50 p-4">
          <label class="text-sm font-medium text-amber-900">Önceki Gebelik / Sezaryen</label>
          <p class="text-xs text-amber-700 mb-2">Karın germe (Tummy Tuck) prosedürü için gereklidir.</p>
          <div class="flex gap-3">
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="csection" value="no" checked class="accent-amber-600" /> <span class="text-sm">Hayır</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="csection" value="yes" class="accent-amber-600" /> <span class="text-sm">Evet</span></label>
          </div>
        </div>

        <div>
          <label class="text-sm text-slate-600">Diğer hastalık veya ameliyat geçmişiniz (Serbest Metin)</label>
          <textarea id="medHistory" rows="3" class="mt-1 w-full rounded-lg border border-slate-200 p-2.5 text-sm focus:outline-none focus:border-slate-400" placeholder="Varsa geçmiş ameliyatlarınızı ve diğer hastalıklarınızı belirtiniz..."></textarea>
        </div>
      </div>

      <div class="mt-6 flex justify-between">
        <button onclick="prevStep(2)" class="rounded-lg border border-slate-200 text-slate-600 px-5 py-2 text-sm">← Geri</button>
        <button onclick="nextStep(2)" class="rounded-lg bg-black text-white px-5 py-2 text-sm font-medium hover:bg-slate-800">Devam →</button>
      </div>
    </div>

    <div id="sec-3" class="hidden bg-white rounded-xl shadow p-6 mb-4">
      <h2 class="font-semibold text-lg mb-1">Alışkanlıklar</h2>
      <p class="text-sm text-slate-500 mb-5">Cerrahi riski doğrudan etkileyen bilgiler.</p>

      <div class="space-y-4">
        <div class="rounded-lg border border-slate-200 p-4">
          <label class="text-sm font-medium text-slate-700">Sigara Kullanımı *</label>
          <div class="mt-3 space-y-2">
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="smoking" value="never" checked class="accent-black" onchange="toggleSmokeDetail()" /> <span class="text-sm">Hiç kullanmadım</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="smoking" value="quit_6m_plus" class="accent-black" onchange="toggleSmokeDetail()" /> <span class="text-sm">Bıraktım — 6 aydan fazla önce</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="smoking" value="quit_recent" class="accent-black" onchange="toggleSmokeDetail()" /> <span class="text-sm">Bıraktım — son 6 ay içinde</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="smoking" value="active" class="accent-black" onchange="toggleSmokeDetail()" /> <span class="text-sm">Aktif içiyorum</span></label>
          </div>
          <div id="smoke-detail" class="hidden mt-3">
            <label class="text-sm text-slate-600">Günde kaç adet? / Ne zaman bıraktınız?</label>
            <input id="smokeDetail" class="mt-1 w-full rounded-lg border border-slate-200 p-2.5 text-sm focus:outline-none focus:border-slate-400" placeholder="Örn: 15 adet/gün veya 3 ay önce bıraktım" />
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="rounded-lg border border-slate-200 p-3">
            <label class="text-sm font-medium text-slate-700">Alkol Tüketimi</label>
            <div class="mt-2 space-y-1">
              <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="alcohol" value="none" checked class="accent-black" /> <span class="text-sm">Kullanmıyorum</span></label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="alcohol" value="occasional" class="accent-black" /> <span class="text-sm">Sosyal (ara sıra)</span></label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="alcohol" value="regular" class="accent-black" /> <span class="text-sm">Düzenli</span></label>
            </div>
          </div>

          <div class="rounded-lg border border-slate-200 p-3">
            <label class="text-sm font-medium text-slate-700">Büyük Kilo Kaybı (>15 kg)</label>
            <p class="text-xs text-slate-400 mb-2">Son 2 yıl içinde</p>
            <div class="flex gap-3 mt-2">
              <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="majorWeightLoss" value="no" checked class="accent-black" /> <span class="text-sm">Hayır</span></label>
              <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="majorWeightLoss" value="yes" class="accent-black" /> <span class="text-sm">Evet</span></label>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-6 flex justify-between">
        <button onclick="prevStep(3)" class="rounded-lg border border-slate-200 text-slate-600 px-5 py-2 text-sm">← Geri</button>
        <button onclick="nextStep(3)" class="rounded-lg bg-black text-white px-5 py-2 text-sm font-medium hover:bg-slate-800">Devam →</button>
      </div>
    </div>

    <div id="sec-4" class="hidden bg-white rounded-xl shadow p-6 mb-4">
      <h2 class="font-semibold text-lg mb-1">Beklentileriniz ve Onay</h2>
      <p class="text-sm text-slate-500 mb-5">Operasyondan beklentileriniz ve yasal beyanınız.</p>

      <div class="mt-4">
        <label class="text-sm text-slate-600">Beklentilerinizi kısaca yazın *</label>
        <textarea id="expectations" rows="4" class="mt-1 w-full rounded-lg border border-slate-200 p-2.5 text-sm focus:outline-none focus:border-slate-400" placeholder="Ne tür bir değişiklik istiyorsunuz? Sizi en çok endişelendiren şey nedir?"></textarea>
      </div>

      <div class="mt-6 p-4 bg-slate-100/80 rounded-lg border border-slate-200">
        <label class="flex items-start gap-3 cursor-pointer">
          <input type="checkbox" id="legalConsent" class="accent-black w-5 h-5 mt-0.5 flex-shrink-0" />
          <span class="text-xs text-slate-600 leading-relaxed">
            <strong>Hukuki Beyan:</strong> Bu formda belirttiğim tüm sağlık geçmişimin, geçirdiğim hastalıkların, ameliyatların ve kullandığım ilaçların eksiksiz ve doğru olduğunu beyan ederim. Hastalığımı/ilaçlarımı gizlemem veya eksik bildirmem durumunda oluşabilecek anestezi ve cerrahi komplikasyonlarda tüm tıbbi ve hukuki sorumluluğun şahsıma ait olduğunu kabul ediyorum.
          </span>
        </label>
      </div>

      <div class="mt-6 flex justify-between">
        <button onclick="prevStep(4)" class="rounded-lg border border-slate-200 text-slate-600 px-5 py-2 text-sm">← Geri</button>
        <button onclick="submitForm()" id="submitBtn" class="rounded-lg bg-black text-white px-5 py-2 text-sm font-medium hover:bg-slate-800">Formu Gönder ✓</button>
      </div>
    </div>

    <div id="sec-success" class="hidden bg-white rounded-xl shadow p-10 mb-4 text-center">
      <div class="text-5xl mb-4 text-emerald-500">✓</div>
      <h2 class="text-xl font-semibold">Formunuz kliniğe ulaştı</h2>
      <p class="text-slate-500 mt-2 text-sm">Hekimimiz ön değerlendirmeyi yaptıktan sonra sizinle iletişime geçilecektir.</p>
      <div class="mt-4 inline-block rounded-lg bg-slate-50 border border-slate-200 px-4 py-2">
        <span class="text-xs text-slate-500">Vaka ID: </span>
        <span id="caseIdDisplay" class="font-mono text-sm font-semibold text-slate-800"></span>
      </div>
    </div>

    <div class="text-xs text-slate-400 text-center pb-6">
      Kayıtlar klinisyen tarafından doğrulanacaktır. Yanlış veya eksik beyan ameliyat kararını etkileyebilir.
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB1j6BthE6pSHzqW82dVaphyD2IiI03LN8",
      authDomain: "surgicheck-v3.firebaseapp.com",
      projectId: "surgicheck-v3",
      storageBucket: "surgicheck-v3.firebasestorage.app",
      messagingSenderId: "907975258387",
      appId: "1:907975258387:web:6e26d8deddbd8f52e22ae6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ─── DYNAMIC FORM LOGIC ──────────────────────────────────────────────────
    document.getElementById("procedure").addEventListener("change", (e) => {
      const proc = e.target.value;
      const tummyBlock = document.getElementById("dynamic-tummy");
      if (proc === "Tummy Tuck") {
        tummyBlock.classList.remove("hidden");
      } else {
        tummyBlock.classList.add("hidden");
        document.querySelector('input[name="csection"][value="no"]').checked = true;
      }
    });

    // ─── BMI (Sanitized) ─────────────────────────────────────────────────────
    function calcBMI() {
      let h = parseFloat(document.getElementById("heightCm").value);
      const w = parseFloat(document.getElementById("weightKg").value);
      const disp = document.getElementById("bmi-display");
      
      if (!h || !w) { disp.classList.add("hidden"); return null; }
      if (h < 3) { h = h * 100; } 
      
      const bmi = w / Math.pow(h / 100, 2);
      const note = bmi < 18.5 ? "(Düşük kilolu)" : bmi < 25 ? "(Normal)" : bmi < 30 ? "(Kilolu)" : bmi < 35 ? "(Obez I)" : "(Obez II+)";
      
      document.getElementById("bmi-val").textContent = bmi.toFixed(1);
      document.getElementById("bmi-note").textContent = note;
      disp.classList.remove("hidden");
      return parseFloat(bmi.toFixed(1));
    }
    document.getElementById("heightCm").addEventListener("input", calcBMI);
    document.getElementById("weightKg").addEventListener("input", calcBMI);

    // ─── STEPS ───────────────────────────────────────────────────────────────
    window.nextStep = function(from) {
      if (!validateStep(from)) return;
      document.getElementById("sec-" + from).classList.add("hidden");
      document.getElementById("sec-" + (from + 1)).classList.remove("hidden");
      updateDots(from + 1);
      window.scrollTo({ top: 0, behavior: "smooth" });
    };

    window.prevStep = function(from) {
      document.getElementById("sec-" + from).classList.add("hidden");
      document.getElementById("sec-" + (from - 1)).classList.remove("hidden");
      updateDots(from - 1);
      window.scrollTo({ top: 0, behavior: "smooth" });
    };

    function updateDots(active) {
      for (let i = 1; i <= 4; i++) {
        const dot = document.getElementById("dot-" + i);
        if (i < active) {
          dot.className = "w-7 h-7 rounded-full flex items-center justify-center text-xs font-semibold bg-emerald-600 text-white flex-shrink-0";
          dot.textContent = "✓";
        } else if (i === active) {
          dot.className = "w-7 h-7 rounded-full flex items-center justify-center text-xs font-semibold bg-black text-white flex-shrink-0";
          dot.textContent = i;
        } else {
          dot.className = "w-7 h-7 rounded-full flex items-center justify-center text-xs font-semibold bg-slate-200 text-slate-500 flex-shrink-0";
          dot.textContent = i;
        }
      }
    }

    function validateStep(step) {
      if (step === 1) {
        const fields = ["procedure", "revision", "fullName", "phone", "email", "age", "heightCm", "weightKg"];
        for (const f of fields) {
          if (!document.getElementById(f).value.trim()) {
            showAlert("err", "Lütfen tüm zorunlu alanları doldurun.");
            return false;
          }
        }
      }
      if (step === 4) {
        if (!document.getElementById("expectations").value.trim()) {
          showAlert("err", "Lütfen beklentilerinizi yazın."); return false;
        }
        if (!document.getElementById("legalConsent").checked) {
          showAlert("err", "Formu göndermek için lütfen Hukuki Beyan metnini okuyup onaylayınız."); 
          return false;
        }
      }
      return true;
    }

    window.toggleSmokeDetail = function() {
      const val = document.querySelector('input[name="smoking"]:checked')?.value;
      const d = document.getElementById("smoke-detail");
      d.classList.toggle("hidden", val === "never" || val === "quit_6m_plus");
    };

    // ─── SUBMIT ──────────────────────────────────────────────────────────────
    window.submitForm = async function() {
      if (!validateStep(4)) return;

      const btn = document.getElementById("submitBtn");
      btn.disabled = true;
      btn.textContent = "Kaydediliyor...";

      try {
        const bmi = calcBMI();
        let height = parseFloat(document.getElementById("heightCm").value);
        if (height < 3) { height = height * 100; } 
        
        const procName = document.getElementById("procedure").value;

        const payload = {
          clinic: { name: "Leo Klinik" },
          patient: {
            fullName: document.getElementById("fullName").value.trim(),
            phone: document.getElementById("phone").value.trim(),
            email: document.getElementById("email").value.trim(),
            age: Number(document.getElementById("age").value),
          },
          procedure: {
            name: procName,
            revision: document.getElementById("revision").value === "yes"
          },
          anthropometrics: {
            heightCm: height,
            weightKg: Number(document.getElementById("weightKg").value),
            bmi: bmi,
          },
          risks: {
            cardiac: document.querySelector('input[name="cardiac"]:checked')?.value === "yes",
            dvt: document.querySelector('input[name="dvt"]:checked')?.value === "yes",
            diabetes: document.querySelector('input[name="diabetes"]:checked')?.value === "yes",
            ht: document.querySelector('input[name="ht"]:checked')?.value === "yes",
            activeMalignancy: document.querySelector('input[name="malignancy"]:checked')?.value === "yes",
            keloid: document.querySelector('input[name="keloid"]:checked')?.value === "yes",
            csection: procName === "Tummy Tuck" ? (document.querySelector('input[name="csection"]:checked')?.value === "yes") : false,
            
            medBloodThinners: document.getElementById("med_bloodThinners").checked,
            medOcp: document.getElementById("med_ocp").checked,
            medGlp1: document.getElementById("med_glp1").checked,
            medAcne: document.getElementById("med_acne").checked,
            medPsych: document.getElementById("med_psych").checked,
            medSteroid: document.getElementById("med_steroid").checked,
            medOther: document.getElementById("med_other").value.trim() || null,

            smoking: document.querySelector('input[name="smoking"]:checked')?.value ?? "never",
            smokeDetail: document.getElementById("smokeDetail").value.trim() || null,
            alcohol: document.querySelector('input[name="alcohol"]:checked')?.value ?? "none",
            majorWeightLoss: document.querySelector('input[name="majorWeightLoss"]:checked')?.value === "yes",
          },
          medHistory: document.getElementById("medHistory").value.trim() || null,
          expectations: document.getElementById("expectations").value.trim(),
          legalConsentVerified: document.getElementById("legalConsent").checked,
          clinician: {
            asa: null,
            smokingVerified: null,
            anticoagVerified: null,
            decision: null,
            rationale: null,
            name: null,
            examNote: null,
            validations: {}
          },
          status: "patient_submitted",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };

        const ref = await addDoc(collection(db, "cases"), payload);

        document.getElementById("sec-4").classList.add("hidden");
        document.getElementById("sec-success").classList.remove("hidden");
        document.getElementById("caseIdDisplay").textContent = ref.id;
        window.scrollTo({ top: 0, behavior: "smooth" });

      } catch (err) {
        console.error(err);
        showAlert("err", "Kayıt sırasında hata oluştu. Lütfen tekrar deneyin.");
        btn.disabled = false;
        btn.textContent = "Formu Gönder ✓";
      }
    };

    function showAlert(type, msg) {
      const el = document.getElementById("alert");
      el.classList.remove("hidden");
      el.className = "mb-4 rounded-lg p-3 text-sm " + (type === "ok"
        ? "bg-emerald-50 text-emerald-800 border border-emerald-200"
        : "bg-rose-50 text-rose-800 border border-rose-200");
      el.textContent = msg;
      setTimeout(() => el.classList.add("hidden"), 3500);
    }
    window.showAlert = showAlert;
  </script>
</body>
</html>
